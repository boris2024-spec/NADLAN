# Интеграция API городов data.gov.il

## Обзор

Интегрирован API правительства Израиля для получения списка израильских городов в реальном времени. API используется в форме создания недвижимости для автодополнения названий городов.

## Структура реализации

### 1. Сервис API (`nadlan_front/src/services/citiesApi.js`)

Сервис для работы с API data.gov.il:

**Основные функции:**

- `getAllCities()` - Получить все города Израиля (с кэшированием на 24 часа)
- `searchCities(query)` - Поиск городов по запросу (возвращает до 10 результатов)
- `getCityByName(cityName)` - Получить детальную информацию о конкретном городе
- `getFallbackCities()` - Запасной список популярных городов (если API недоступен)

**Особенности:**
- Кэширование результатов на 24 часа для уменьшения нагрузки на API
- Обработка ошибок с возвратом к запасному списку городов
- Фильтрация и сортировка результатов на иврите
- Удаление дубликатов

### 2. Компонент автодополнения (`nadlan_front/src/components/ui/CityAutocomplete.jsx`)

React компонент с автодополнением для выбора города:

**Возможности:**
- Поиск в реальном времени с debounce 300ms
- Dropdown с результатами поиска
- Поддержка клавиатурной навигации (Enter, Escape)
- Автозакрытие при клике вне компонента
- Индикатор загрузки
- Поддержка темной темы
- Валидация с отображением ошибок

**Props:**
```javascript
{
  value: string,           // Текущее значение
  onChange: function,      // Callback при изменении
  placeholder: string,     // Placeholder текст
  className: string,       // Дополнительные CSS классы
  required: boolean,       // Обязательное поле
  error: boolean          // Флаг ошибки валидации
}
```

### 3. Интеграция в форму (`nadlan_front/src/pages/CreatePropertyPage.jsx`)

Компонент интегрирован в форму создания недвижимости на шаге 2 (Местоположение):

```jsx
<CityAutocomplete
    value={formData.location.city}
    onChange={(city) => handleInputChange({ 
        target: { 
            name: 'location.city', 
            value: city 
        } 
    })}
    placeholder="תל אביב"
    error={!!validationErrors['location.city']}
    required
/>
```

## API Endpoint

**Base URL:** `https://data.gov.il/api/3/action/datastore_search`

**Resource ID:** `5c78e9fa-c2e2-4771-93ff-7f400a12f7ba`

### Примеры запросов:

1. **Получить все города:**
```
GET https://data.gov.il/api/3/action/datastore_search?resource_id=5c78e9fa-c2e2-4771-93ff-7f400a12f7ba&limit=1500
```

2. **Поиск конкретного города:**
```
GET https://data.gov.il/api/3/action/datastore_search?resource_id=5c78e9fa-c2e2-4771-93ff-7f400a12f7ba&filters={"שם_ישוב":"תל אביב - יפו"}
```

### Структура ответа:

```json
{
  "success": true,
  "result": {
    "records": [
      {
        "שם_ישוב": "תל אביב - יפו",
        "סמל_ישוב": "5000",
        // другие поля...
      }
    ],
    "total": 1
  }
}
```

## Тестирование

Создан HTML файл для тестирования API: `test-cities-api.html`

**Как использовать:**
1. Откройте файл в браузере
2. Протестируйте три варианта использования:
   - Получение всех городов
   - Поиск городов
   - Получение информации о конкретном городе

## Запасной список городов

Если API недоступен, система автоматически переключается на статический список из 60+ популярных городов Израиля, включая:
- Тель-Авив - Яффо
- Иерусалим
- Хайфа
- Беэр-Шева
- Ришон-ле-Цион
- И другие...

## Производительность

- **Кэширование:** Результаты кэшируются на 24 часа в памяти браузера
- **Debounce:** Поиск выполняется с задержкой 300ms для уменьшения количества запросов
- **Лимит результатов:** Отображается максимум 10 результатов поиска

## Использование в других компонентах

Компонент `CityAutocomplete` полностью переиспользуемый и может быть применен в любой форме:

```jsx
import CityAutocomplete from '../components/ui/CityAutocomplete';

<CityAutocomplete
    value={city}
    onChange={setCity}
    placeholder="בחר עיר"
    required
/>
```

## Поддержка

- RTL (справа налево) для иврита
- Темная тема
- Адаптивный дизайн
- Доступность (клавиатурная навигация)

## Будущие улучшения

Возможные расширения функциональности:
1. Добавить геокодирование для получения координат
2. Показывать дополнительную информацию о городе (код, район и т.д.)
3. Группировка городов по регионам
4. Поддержка множественного выбора
5. История последних выборов
